/*
LaskaKit ESP32-C3 LPkit v3.2
SHT 40
LiPol 1500 mAh
Data na TMEP.cz
WiFiManager
Deep Sleep 30 minut (zmÄ›nitelnÃ©)
USB CDC onboot = enabled

Optimalizace:
- LogovÃ¡nÃ­ Äasu bÄ›hu
- AgresivnÃ­ vypnutÃ­ WiFi
- Kontrola napÄ›tÃ­ baterie s adaptivnÃ­m spÃ¡nkem
- ZkrÃ¡cenÃ© timeouty
*/

#include <WiFi.h>
#include <esp_wifi.h>
#include <HTTPClient.h>
#include <SPI.h>
#include <Wire.h>
#include <WiFiManager.h>
#include "Adafruit_SHT4x.h"

#define ADCBpin 0
#define bDeviderRatio 1.7693877551

// Deep sleep - ZMÄšÅ‡ NA 1 PRO TESTOVÃNÃ (v minutÃ¡ch)
#define SLEEP_MINUTES 5  // â† ZmÄ›Åˆ na 1 pro test
#define SLEEP_TIME SLEEP_MINUTES * 60ULL * 1000000ULL

// KritickÃ© napÄ›tÃ­ pro prodlouÅ¾enÃ­ spÃ¡nku
#define LOW_VOLTAGE_THRESHOLD 3.5    // Pokud je napÄ›tÃ­ pod touto hodnotou
#define LOW_VOLTAGE_SLEEP_HOURS 2    // SpÃ­ 2 hodiny mÃ­sto 30 minut

static Adafruit_SHT4x sht4 = Adafruit_SHT4x();

String serverName = "http:/xxxx.tmep.cz/index.php?";

void setup() {
  Serial.begin(115200);
  delay(100);
  
  unsigned long startTime = millis();
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘   ESP32-C3 LPkit - Start mÄ›Å™enÃ­   â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  // NEJDÅ˜ÃV KONTROLA NAPÄšTÃ
  float bat_voltage = checkBatteryVoltage();
  
  // Pokud je napÄ›tÃ­ kritickÃ©, prodlouÅ¾ spÃ¡nek
  if (bat_voltage > 0 && bat_voltage < LOW_VOLTAGE_THRESHOLD) {
    Serial.println("\nâš ï¸  KRITICKÃ‰ NAPÄšTÃ BATERIE!");
    Serial.print("   ProdluÅ¾uji spÃ¡nek na ");
    Serial.print(LOW_VOLTAGE_SLEEP_HOURS);
    Serial.println(" hodiny");
    
    unsigned long runtime = millis() - startTime;
    Serial.print("\nâ±ï¸  CelkovÃ½ Äas bÄ›hu: ");
    Serial.print(runtime);
    Serial.println(" ms");
    
    goToSleep(LOW_VOLTAGE_SLEEP_HOURS * 60); // PÅ™evod na minuty
    return;
  }
  
  // I2C sbÄ›rnice pro Äidlo teploty a vlhkosti
  Wire.begin(8, 10);
  delay(50);
  
  // Inicializace SHT40 s kontrolou
  if (!sht4.begin()) {
    Serial.println("âŒ SHT40 senzor nenalezen!");
    unsigned long runtime = millis() - startTime;
    Serial.print("â±ï¸  ÄŒas bÄ›hu pÅ™ed spanÃ­m: ");
    Serial.print(runtime);
    Serial.println(" ms");
    goToSleep(SLEEP_MINUTES);
    return;
  }
  
  Serial.println("âœ“ SHT40 senzor inicializovÃ¡n");
  sht4.setPrecision(SHT4X_HIGH_PRECISION);
  sht4.setHeater(SHT4X_NO_HEATER);

  // WiFiManager s kratÅ¡Ã­mi timeouty
  WiFiManager wifiManager;
  wifiManager.setConfigPortalTimeout(60);  // 60 sekund na konfiguraci (pokud nenÃ­ uloÅ¾enÃ¡ sÃ­Å¥)
  wifiManager.setConnectTimeout(20);        // 20 sekund na pÅ™ipojenÃ­ k uloÅ¾enÃ© sÃ­ti
  
  Serial.println("\nğŸ“¡ PÅ™ipojovÃ¡nÃ­ k WiFi...");
  
  unsigned long wifiStartTime = millis();
  
  // AutomatickÃ© pÅ™ipojenÃ­ nebo konfiguraÄnÃ­ portÃ¡l
  if (!wifiManager.autoConnect("ESP32-LPkit-Config")) {
    Serial.println("âŒ Selhalo pÅ™ipojenÃ­ WiFi");
    unsigned long runtime = millis() - startTime;
    Serial.print("â±ï¸  ÄŒas bÄ›hu: ");
    Serial.print(runtime);
    Serial.println(" ms");
    Serial.println("   Restartuji...");
    delay(1000);
    ESP.restart();
  }

  unsigned long wifiConnectTime = millis() - wifiStartTime;
  
  Serial.println("âœ“ PÅ™ipojeno k WiFi");
  Serial.print("   IP adresa: ");
  Serial.println(WiFi.localIP());
  Serial.print("   RSSI: ");
  Serial.print(WiFi.RSSI());
  Serial.println(" dBm");
  Serial.print("   ÄŒas pÅ™ipojenÃ­: ");
  Serial.print(wifiConnectTime);
  Serial.println(" ms");

  // MÄ›Å™enÃ­ a odeslÃ¡nÃ­ dat
  measureAndSend(bat_voltage);
  
  // VypoÄÃ­tej celkovÃ½ Äas bÄ›hu
  unsigned long runtime = millis() - startTime;
  Serial.print("\nâ±ï¸  CELKOVÃ ÄŒAS BÄšHU: ");
  Serial.print(runtime);
  Serial.println(" ms");
  Serial.print("   (");
  Serial.print(runtime / 1000.0, 1);
  Serial.println(" sekund)");
  
  // PÅ™echod do deep sleep
  goToSleep(SLEEP_MINUTES);
}

void loop() {
  // Loop se nikdy nespustÃ­ kvÅ¯li deep sleep
}

float checkBatteryVoltage() {
  float bat_voltage = analogReadMilliVolts(ADCBpin) * bDeviderRatio / 1000.0;
  
  Serial.println("\nğŸ”‹ NAPÄšTÃ BATERIE");
  Serial.print("   NapÄ›tÃ­: ");
  Serial.print(bat_voltage, 2);
  Serial.println(" V");
  
  // ProcentuÃ¡lnÃ­ odhad (LiPol 3.0V = 0%, 4.2V = 100%)
  float percent = (bat_voltage - 3.0) / 1.2 * 100.0;
  if (percent > 100) percent = 100;
  if (percent < 0) percent = 0;
  
  Serial.print("   Odhad: ~");
  Serial.print(percent, 0);
  Serial.println(" %");
  
  if (bat_voltage < 3.3) {
    Serial.println("   âš ï¸  VAROVÃNÃ: NÃ­zkÃ© napÄ›tÃ­!");
  } else if (bat_voltage < LOW_VOLTAGE_THRESHOLD) {
    Serial.println("   âš ï¸  KritickÃ¡ ÃºroveÅˆ!");
  }
  
  return bat_voltage;
}

void measureAndSend(float bat_voltage) {
  /* MÄšÅ˜ENÃ SÃLY WiFi */
  int rssi = WiFi.RSSI();
  Serial.println("\nğŸ“¶ WIFI SIGNÃL");
  Serial.print("   RSSI: ");
  Serial.print(rssi);
  Serial.println(" dBm");
  /*------------------*/

  /* ÄŒIDLO TEPLOTY A VLHKOSTI */
  Serial.println("\nğŸŒ¡ï¸  MÄšÅ˜ENÃ TEPLOTY A VLHKOSTI");
  sensors_event_t humidity, temp;
  
  uint32_t timestamp = millis();
  sht4.getEvent(&humidity, &temp);
  uint32_t measureTime = millis() - timestamp;
  
  float temperature = temp.temperature;
  float humidityValue = humidity.relative_humidity;
  
  Serial.print("   Teplota: ");
  Serial.print(temperature, 1);
  Serial.println(" Â°C");
  Serial.print("   Vlhkost: ");
  Serial.print(humidityValue, 1);
  Serial.println(" % rH");
  Serial.print("   ÄŒas mÄ›Å™enÃ­: ");
  Serial.print(measureTime);
  Serial.println(" ms");
  /*--------------------------*/

  /* ODESLÃNÃ DAT NA TMEP.cz */
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nğŸ“¤ ODESÃLÃNÃ DAT");
    HTTPClient http;
    
    // SestavenÃ­ URL s parametry
    String serverPath = serverName + 
                       "teplota=" + String(temperature, 2) + 
                       "&vlhkost=" + String(humidityValue, 2) + 
                       "&v=" + String(bat_voltage, 2) + 
                       "&rssi=" + String(rssi);
    
    Serial.println("   URL: " + serverPath);
    
    uint32_t httpStartTime = millis();
    
    // ZaÄÃ¡tek HTTP spojenÃ­
    http.begin(serverPath.c_str());
    http.setTimeout(10000); // 10 sekund timeout
    
    // HTTP GET request
    int httpResponseCode = http.GET();
    
    uint32_t httpTime = millis() - httpStartTime;
    
    if (httpResponseCode > 0) {
      Serial.print("   âœ“ HTTP Response: ");
      Serial.println(httpResponseCode);
      String payload = http.getString();
      Serial.print("   OdpovÄ›Ä: ");
      Serial.println(payload);
    } else {
      Serial.print("   âŒ Error code: ");
      Serial.println(httpResponseCode);
      Serial.print("   Chyba: ");
      Serial.println(http.errorToString(httpResponseCode));
    }
    
    Serial.print("   ÄŒas HTTP requestu: ");
    Serial.print(httpTime);
    Serial.println(" ms");
    
    // UvolnÄ›nÃ­ zdrojÅ¯
    http.end();
  } else {
    Serial.println("\nâŒ WiFi odpojeno - data nebyla odeslÃ¡na");
  }
  /*----------------------------*/
  
  delay(100);
}

void goToSleep(int sleepMinutes) {
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.print("â•‘   ğŸ’¤ Deep Sleep: ");
  Serial.print(sleepMinutes);
  Serial.print(" min");
  if (sleepMinutes < 10) Serial.print(" ");
  if (sleepMinutes < 100) Serial.print(" ");
  Serial.println("       â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  Serial.flush(); // PoÄkej na dokonÄenÃ­ sÃ©riovÃ© komunikace
  
  // AGRESIVNÃ VYPNUTÃ WiFi
  HTTPClient().end();  // UzavÅ™i pÅ™Ã­padnÃ© otevÅ™enÃ© spojenÃ­
  WiFi.disconnect(true);
  WiFi.mode(WIFI_OFF);
  esp_wifi_stop();
  esp_wifi_deinit();
  
  // VypnutÃ­ Bluetooth (pokud by byl aktivnÃ­)
  btStop();
  
  // NastavenÃ­ deep sleep
  uint64_t sleepTime = sleepMinutes * 60ULL * 1000000ULL;
  esp_sleep_enable_timer_wakeup(sleepTime);
  
  delay(100);
  
  // SpuÅ¡tÄ›nÃ­ deep sleep
  esp_deep_sleep_start();
}
